ittf

    $*
        AI extension of std_62443_4_1_extra
        model std_62443_4_1_extra in /.wizzi-override/models/62443-4-1-extra.json.ittf
        Adds 'key_aspects' and 'related_standards'
    *$

    $
        var product_supplier = wzCtx.Config.ai.product_supplier.name;
        var x_4_1_options = {
            product_supplier_JSON: _.stringify(wzCtx.product_supplier.instances[product_supplier], null, null),
            step_2_JSONSchema: _.stringify(wzCtx.schemas.x_4_1_process_ai_step_2, null, null),
            step_3_JSONSchema: _.stringify(wzCtx.schemas.x_4_1_process_ai_step_3, null, null),
            step_4_JSONSchema: _.stringify(wzCtx.schemas.x_4_1_process_ai_step_4, null, null),
        }        
        // var provider = 'chatGPT';
        var provider = 'deepSeek';
        // var provider = 'grok';
        var product_context = '{"product_context":{"manufacturer":"Breton Spa","machine_types":[{"type":"CNC Machining Centers","description":"High-precision CNC machines for stone and metalworking, featuring multi-axis control for complex geometries.","supported_protocols":["OPC UA with Basic256Sha256","PROFINET with PN Security","EtherNet/IP with CIP Security","Modbus TCP with TLS"]},{"type":"Stone Cutting Machines","description":"Automated saws for cutting granite and marble with high-speed, water-cooled blades.","supported_protocols":["OPC UA with Basic256Sha256","PROFINET with PN Security","MQTT with TLS","EtherCAT with Secure Profile"]},{"type":"Polishing Machines","description":"Machines for surface finishing of stone, equipped with automated abrasive tools and precision sensors.","supported_protocols":["OPC UA with Basic256Sha256","PROFINET with PN Security","EtherNet/IP with CIP Security","S7comm with Secure Authentication"]},{"type":"Composite Material Processing Lines","description":"Integrated systems for cutting, shaping, and curing composite materials for aerospace and automotive.","supported_protocols":["OPC UA with Basic256Sha256","PROFINET with PN Security","MQTT with TLS","CANopen with Secure Extensions"]}],"applications":[{"name":"Natural Stone Processing","criticality":"High","description":"Cutting and polishing marble and granite for construction, requiring high precision to avoid material waste."},{"name":"Metalworking for Precision Parts","criticality":"High","description":"Machining metal components for industrial equipment, critical for maintaining tight tolerances."},{"name":"Composite Material Fabrication","criticality":"Medium","description":"Producing lightweight composite parts for aerospace, ensuring structural integrity and quality."},{"name":"Surface Finishing for Decorative Stone","criticality":"Low","description":"Polishing stone surfaces for aesthetic applications, with minimal operational impact if disrupted."}],"key_features":[{"feature":"High-Precision CNC Control Systems","description":"PLC-based systems with sub-millimeter accuracy for complex machining tasks.","security_support":["CR1: Identification and Authentication Control","CR3: System Integrity"]},{"feature":"Secure Remote Access","description":"Enables remote diagnostics and updates via encrypted channels for maintenance.","security_support":["CR4: Data Confidentiality","CR5: Restricted Data Flow"]},{"feature":"Firmware Signing","description":"Ensures only verified firmware is loaded, preventing unauthorized modifications.","security_support":["CR3: System Integrity","CR6: Timely Response to Events"]},{"feature":"Network Segmentation Support","description":"Integrates with OT network zones to isolate critical control functions.","security_support":["CR5: Restricted Data Flow","CR7: Resource Availability"]},{"feature":"Incident Logging","description":"Records security events for analysis, ensuring traceability of unauthorized access.","security_support":["CR6: Timely Response to Events","CR3: System Integrity"]}],"operational_environment":{"description":"Industrial facilities for stone, composite, and metal processing with high dust and noise levels.","conditions":{"temperature_range":"5-40Â°C","dust_level":"High (stone processing environments)","network_type":"Segmented industrial networks with DMZ for IT-OT integration"}},"industry_4_0_compliance":true,"security_profile":{"supported_sl":["SL 1","SL 2","SL 3"],"certifications":["IEC 62443-4-2","IEC 62443-4-1"],"common_threats":["Ransomware targeting control systems, disrupting production and causing downtime.","MitM attacks on industrial protocols, compromising data integrity.","Data manipulation in HMI interfaces, leading to incorrect process parameters."]},"product_version":{"current_version":"2025.1","last_updated":"2025-06-01"}}}';
        var practice_ia_step_3_json_schema = '{"$schema":"http://json-schema.org/draft-07/schema#","type":"object","description":"Generalized JSON schema for IEC 62443-4-1 practices","required":["practice","code","subCode","name","description","details","standard_compliance","last_updated"],"properties":{"practice":{"type":"string","description":"Numeric identifier of the practice within IEC 62443-4-1","pattern":"^[0-9]+$"},"code":{"type":"string","description":"Alphanumeric code for the practice (e.g., SG-7, SM-5)","pattern":"^[A-Z]{2}-[0-9]+$"},"subCode":{"type":"string"},"name":{"type":"string","description":"Name of the practice (e.g., Documentation review)","minLength":1},"description":{"type":"string","description":"Detailed description of the practice as per IEC 62443-4-1","minLength":1},"details":{"type":"object","description":"Detailed information addressing key aspects of the practice","required":["risk_assessment_and_threat_modeling","audit_and_compliance_verification","training_and_competency_requirements","tooling_and_automation_support","handling_legacy_systems_and_constraints","stakeholder_collaboration_and_governance","continuous_improvement_and_updates"],"properties":{"risk_assessment_and_threat_modeling":{"type":"object","description":"Details for risk assessment and threat modeling related to the practice","required":["why","methodologies","tools","case_study"],"properties":{"why":{"type":"string","minLength":1},"methodologies":{"type":"array","items":{"type":"object","required":["name","description"],"properties":{"name":{"type":"string","minLength":1},"description":{"type":"string","minLength":1}},"additionalProperties":false},"minItems":1},"tools":{"type":"array","items":{"type":"object","required":["name","purpose"],"properties":{"name":{"type":"string","minLength":1},"purpose":{"type":"string","minLength":1}},"additionalProperties":false},"minItems":1},"case_study":{"type":"object","required":["example"],"properties":{"example":{"type":"string","minLength":1}},"additionalProperties":false}},"additionalProperties":false},"audit_and_compliance_verification":{"type":"object","description":"Details for auditing and verifying compliance with the practice","required":["why","audit_checklist","metrics","compliance_procedure"],"properties":{"why":{"type":"string","minLength":1},"audit_checklist":{"type":"array","items":{"type":"string","minLength":1},"minItems":1},"metrics":{"type":"array","items":{"type":"object","required":["kpi","target"],"properties":{"kpi":{"type":"string","minLength":1},"target":{"type":"string","minLength":1}},"additionalProperties":false},"minItems":1},"compliance_procedure":{"type":"string","minLength":1}},"additionalProperties":false},"training_and_competency_requirements":{"type":"object","description":"Details for training and competency requirements","required":["why","training_programs","competency_assessment"],"properties":{"why":{"type":"string","minLength":1},"training_programs":{"type":"array","items":{"type":"object","required":["name","description"],"properties":{"name":{"type":"string","minLength":1},"description":{"type":"string","minLength":1}},"additionalProperties":false},"minItems":1},"competency_assessment":{"type":"string","minLength":1}},"additionalProperties":false},"tooling_and_automation_support":{"type":"object","description":"Details for tools and automation supporting the practice","required":["why","tools","automation_strategy"],"properties":{"why":{"type":"string","minLength":1},"tools":{"type":"array","items":{"type":"object","required":["name","purpose"],"properties":{"name":{"type":"string","minLength":1},"purpose":{"type":"string","minLength":1}},"additionalProperties":false},"minItems":1},"automation_strategy":{"type":"string","minLength":1}},"additionalProperties":false},"handling_legacy_systems_and_constraints":{"type":"object","description":"Details for addressing legacy systems in the practice","required":["why","strategies","example_policy"],"properties":{"why":{"type":"string","minLength":1},"strategies":{"type":"array","items":{"type":"object","required":["approach","description"],"properties":{"approach":{"type":"string","minLength":1},"description":{"type":"string","minLength":1}},"additionalProperties":false},"minItems":1},"example_policy":{"type":"string","minLength":1}},"additionalProperties":false},"stakeholder_collaboration_and_governance":{"type":"object","description":"Details for stakeholder collaboration and governance","required":["why","governance_model","conflict_resolution"],"properties":{"why":{"type":"string","minLength":1},"governance_model":{"type":"object","required":["name","roles"],"properties":{"name":{"type":"string","minLength":1},"roles":{"type":"array","items":{"type":"object","required":["role","responsibility"],"properties":{"role":{"type":"string","minLength":1},"responsibility":{"type":"string","minLength":1}},"additionalProperties":false},"minItems":1}},"additionalProperties":false},"conflict_resolution":{"type":"string","minLength":1}},"additionalProperties":false},"continuous_improvement_and_updates":{"type":"object","description":"Details for continuous improvement and policy updates","required":["why","update_process","lessons_learned"],"properties":{"why":{"type":"string","minLength":1},"update_process":{"type":"array","items":{"type":"object","required":["step","description"],"properties":{"step":{"type":"string","minLength":1},"description":{"type":"string","minLength":1}},"additionalProperties":false},"minItems":1},"lessons_learned":{"type":"string","minLength":1}},"additionalProperties":false}},"additionalProperties":false},"standard_compliance":{"type":"string","description":"Reference to the IEC 62443-4-1 standard","enum":["IEC 62443-4-1"]},"last_updated":{"type":"string","description":"Date of last update in YYYY-MM-DD format","pattern":"^[0-9]{4}-[0-9]{2}-[0-9]{2}$"}},"additionalProperties":false}';
        var maxNumInBatch = 4;
        var batches = [];
        var currentBatch = {
            id: 1,
            items: []
        }
        var count = 0;

    $foreach prItem in std_62443_4_1_extra.items
        $if _.isArray(prItem.subs) == false || prItem.subs.length == 0
            $if count > maxNumInBatch
                $
                    batches.push(currentBatch);
                    currentBatch = {
                        id: currentBatch.id + 1,
                        items: [prItem]
                    }
                    count = 1;

            $else
                $
                    prItem.subCode = '';
                    currentBatch.items.push(prItem);
                    count++;

        $else
            $foreach prItemSub in prItem.subs
                $
                    var prItemEx = {
                        practice: prItem.practice,
                        code: prItem.code,
                        name: prItem.name,
                        subCode: prItemSub.description,
                        description: prItem.description + ' ' + prItemSub.description,
                    };    

                $if count > maxNumInBatch
                    $
                        batches.push(currentBatch);
                        currentBatch = {
                            id: currentBatch.id + 1,
                            items: [prItemEx]
                        }
                        count = 1;

                $else
                    $
                        currentBatch.items.push(prItemEx);
                        count++;

    $foreach batch in batches
        $file .wizzi-override/docs/4_1/ai_step_3_in/batch-${batch.id}.ai.ittf
            ai lab
                api-url http://localhost:3000

                $foreach batchItem in batch.items
                    $
                        var batchItemJSONString = _.stringify(batchItem, null, null)
                        var options = {
                            practice: batchItem.practice,
                            practiceName: std_62443_4_1_extra.practices[batchItem.practice].name,
                            code: batchItem.code,
                            name: batchItem.name,
                            subCode: batchItem.subCode,
                            description: batchItem.description,
                            subs: batchItem.subs,
                            subDescription: null,
                            inputJSONString: batchItemJSONString,
                            JSONSchema: x_4_1_options.step_3_JSONSchema,
                            product_supplier_JSON: x_4_1_options.product_supplier_JSON,
                            provider: provider,
                        }
                        if (_.isObject(batchItem.sub)) {
                            options.subDescription = batchItem.sub.description
                        }
                    ia_step_3_item(&options)

    $file .wizzi-override/docs/4_1/ai_step_3_out/index.json.ittf
        {
            [ practices
                $foreach batch in batches
                    ${'$'}include batch-${batch.id}
